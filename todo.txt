[x] Add User Settings for UI Customization
    - Allow users to change UI colors (primary, accent, background).
    - Allow users to set a custom background image.
    - Persist these settings in the user profile/database.
    PLAN:
    1.  **Database**: Update `User` schema in `server.py` to include a `settings` object:
        `settings: { ui_color_primary: str, ui_color_accent: str, background_url: str }`.
    2.  **API**: Update `/api/auth/me` and `/api/auth/login` to return these settings.
    3.  **API**: Create `PATCH /api/user/settings` endpoint to update these fields.
    4.  **Frontend**: Create a `SettingsPage.js`.
    5.  **Frontend**: Add a `ThemeContext` or update `App.js` to apply these styles dynamically (using CSS variables or inline styles on the root/layout).

[x] Implement Thematic System (Premium Feature)
    - Add a "Theme" selector in settings.
    - "Default" theme is free.
    - Premium themes (e.g., "Cyberpunk", "Fantasy", "Horror") require premium status.
    - Themes should modify background/UI and the SYSTEM PROMPT.
    PLAN:
    1.  **Database**: Add `theme` field to `User.settings` schema.
    2.  **Frontend**: Define theme presets (colors, fonts, bg images) in a `themes.js` config file.
    3.  **Frontend**: In `SettingsPage`, allow selection. Check `user.premium` before allowing save.
    4.  **Backend**: In `generate_riddle_with_ai` (or `ModelManager`), read user's theme.
    5.  **Backend**: Update `difficulty_prompts` to include thematic instructions.
        - E.g., if theme='fantasy', append "Write this riddle with a fantasy style, using wizards or dragons."
    6.  **Backend**: Verify premium status on generation if a premium theme is active.

[x] Fix Difficulty Unlocks
    - Investigate why difficulty unlocks (Very Hard, Insane) are currently "unusable".
    - Ensure premium status correctly unlocks these buttons in the UI.
    - Verify backend permissions match frontend state.
    PLAN:
    1.  **frontend/GamePage.js**: Check `isLocked` logic. Currently `(diff.premium && !user.premium) || (dailyStatus?.needs_generation)`.
        - Verify `user.premium` is correctly synced from `App.js` state.
    2.  **frontend/PremiumModal**: Ensure successful payment simulation updates the global `user` state immediately (without refresh).
    3.  **Backend**: Verify `/api/premium/unlock` updates the DB correctly.
    4.  **Backend**: Verify `/api/riddle/generate` enforces the check correctly (it currently raises 403).

[x] Advanced LLM Model Management
    - Decouple LLM logic from server.py into a standalone ModelManager service.
    - Add Settings UI to select different LLM models.
    - Implement discovery and downloading of new Ollama models dynamically.
    PLAN:
    1.  **Backend**: Create `backend/model_manager.py`. Move `OllamaLLM` and fallback logic here.
    2.  **Backend**: Add APIs:
        - `GET /api/models/available` (Local + Online options).
        - `POST /api/models/pull` (Trigger Ollama pull).
        - `POST /api/user/model` (Set preferred model).
    3.  **Backend**: Update `User` schema to store `preferred_model`.
    4.  **Frontend**: In `SettingsPage`, add "AI Model" section. List installed Ollama models via API. Provide "Pull" button for others.

[x] Online Mode Integration
    - Add support for online LLM providers (OpenAI, Anthropic, Gemini).
    - Add API Key management in settings.
    PLAN:
    1.  **Backend**: Create `backend/llm_online.py` with classes for `OpenAILLM`, `AnthropicLLM`, etc.
    2.  **Database**: Store API keys in `User` settings (encrypted!).
        - `settings: { ..., api_keys: { openai: "...", ... } }`.
    3.  **API**: `POST /api/user/settings` to save keys (using existing endpoint).
    4.  **Backend**: Update `ModelManager` to instantiate the correct class based on `user.preferred_model`.
    5.  **Frontend**: Add input fields for API keys in Settings.

[x] Fix Leaderboard
    - Ensure Leaderboard page is accessible and displays data.
    - Clarify "Local Leaderboard" scope.
    - Fix navigation.
    PLAN:
    1.  **Frontend**: Verify `/leaderboard` route exists in `App.js`.
    2.  **frontend/GamePage.js**: Verify "Leaderboard" button navigation.
    3.  **Frontend**: Create/Update `LeaderboardPage.js` to fetch from `/api/leaderboard/global`.
    4.  **Backend**: Ensure `/api/leaderboard/global` returns the top users from `db.users`.
    5.  **UI**: Display a simple table: Rank | Username | Score.
    6.  **Navigation**: Add a "Back to Game" button on Leaderboard page.
